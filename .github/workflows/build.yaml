name: Build and Release

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: clippy, rustfmt

      - name: Run tests
        run: cargo test

      - name: Run clippy
        run: cargo clippy -- -D warnings

      - name: Check formatting
        run: cargo fmt -- --check

  build-and-release:
    name: Build and Create Release
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: x86_64-unknown-linux-musl
          profile: minimal

      - name: Build Release Binary
        run: cargo build --release --target x86_64-unknown-linux-musl

      - name: Strip Binary
        run: strip target/x86_64-unknown-linux-musl/release/pwgen-rs

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Get short SHA
        id: sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nightly-${{ steps.date.outputs.date }}-${{ steps.sha.outputs.sha }}
          release_name: Nightly Build ${{ steps.date.outputs.date }} (${{ steps.sha.outputs.sha }})
          body: |
            Automatic nightly build from main branch

            **Commit**: ${{ github.sha }}
            **Build Date**: ${{ steps.date.outputs.date }}
            **Platform**: Linux x86_64 (musl) - statically linked

            ### Usage
            ```bash
            chmod +x pwgen-rs
            ./pwgen-rs --help
            ```
          draft: false
          prerelease: true
          files: |
            target/x86_64-unknown-linux-musl/release/pwgen-rs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
