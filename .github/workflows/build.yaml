name: Build and Release

on:
  push:
    branches: [ main, master ]

jobs:
  build-and-release:
    name: Build and Create Release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: x86_64-unknown-linux-musl

    - name: Build Release Binary
      run: cargo build --release --target x86_64-unknown-linux-musl

    - name: Strip Binary
      run: strip target/x86_64-unknown-linux-musl/release/pwgen-rs

    - name: Get short SHA
      id: sha
      run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ steps.sha.outputs.sha }}
        release_name: Latest Build (${{ steps.sha.outputs.sha }})
        body: |
          Automatic build from main branch
          
          **Commit**: ${{ github.sha }}
          **Build Date**: $(date -u)
          **Platform**: Linux x86_64 (musl) - statically linked
        draft: false
        prerelease: true
        files: target/x86_64-unknown-linux-musl/release/pwgen-rs
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
